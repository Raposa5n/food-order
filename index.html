<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>點餐與歷史訂單系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .active-category {
            background-color: #0d6efd;
            color: white;
        }

        .menu-highlight {
            background-color: #e7f1ff;
        }
    </style>
</head>

<body class="container py-4">
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><button class="nav-link active" onclick="switchPage('order')">點餐系統</button></li>
        <li class="nav-item"><button class="nav-link" onclick="switchPage('history')">歷史訂單</button></li>
    </ul>

    <div id="order-page">
        <div class="d-flex justify-content-between align-items-center">
            <h1>點餐系統</h1>
            <div id="current-time" class="fw-bold"></div>
        </div>
        <div class="mb-3">
            <input type="text" id="new-category-name" class="form-control mb-2" placeholder="新增分類名稱">
            <button class="btn btn-primary" onclick="addCategory()">新增分類</button>
            <button class="btn btn-danger ms-2" onclick="deleteCategory()">刪除目前分類</button>
        </div>
        <div id="category-buttons" class="d-flex flex-wrap mb-3"></div>
        <div id="menu" class="p-3 rounded border menu-highlight"></div>
        <div class="mt-3">
            <input type="text" id="new-item-name" class="form-control mb-2" placeholder="品項名稱">
            <input type="number" id="new-item-price" class="form-control mb-2" placeholder="價格" min="0" step="0.01">
            <button class="btn btn-primary" onclick="addMenuItem()">新增品項</button>
        </div>
        <div id="order-list" class="mt-4"></div>
        <div class="h4 mt-3" id="total-price">總價: $0</div>
        <button class="btn btn-success mt-3" onclick="completeOrder()">完成訂單</button>
    </div>

    <div id="history-page" style="display: none">
        <h1 class="mb-4">歷史訂單紀錄</h1>
        <div class="mb-3 d-flex gap-2">
            <input type="date" id="filter-date" class="form-control">
            <button class="btn btn-primary" onclick="applyDateFilter()">套用日期篩選</button>
            <button class="btn btn-secondary" onclick="clearFilter()">清除篩選</button>
            <button class="btn btn-success" onclick="exportToExcel()">匯出 Excel</button>
        </div>
        <h2 class="mt-4" id="chartTitle">各分類銷售統計</h2>
        <canvas id="categoryChart" height="100"></canvas>
        <div class="accordion my-4" id="ordersAccordion"></div>
    </div>

    <script>
        let categories = JSON.parse(localStorage.getItem("categories")) || {
            "吐司": [], "蛋餅": [], "漢堡": [], "燒餅": []
        };
        let currentCategory = localStorage.getItem("currentCategory") || "吐司";
        let orders = [];

        function switchPage(page) {
            document.getElementById("order-page").style.display = page === 'order' ? 'block' : 'none';
            document.getElementById("history-page").style.display = page === 'history' ? 'block' : 'none';
            if (page === 'order') {
                renderCategories();
                setCategory(currentCategory);
            } else {
                renderChart();
                renderOrders();
            }
        }

        function updateTime() {
            document.getElementById("current-time").innerText = `現在時間：${new Date().toLocaleTimeString()}`;
        }
        setInterval(updateTime, 1000);
        updateTime();

        function renderCategories() {
            const container = document.getElementById("category-buttons");
            container.innerHTML = "";
            Object.keys(categories).forEach(cat => {
                const btn = document.createElement("button");
                btn.className = `btn m-1 ${cat === currentCategory ? 'active-category' : 'btn-outline-secondary'}`;
                btn.innerText = cat;
                btn.onclick = () => setCategory(cat);
                container.appendChild(btn);
            });
        }

        function setCategory(cat) {
            currentCategory = cat;
            localStorage.setItem("currentCategory", currentCategory);
            renderCategories();
            renderMenu();
        }

        function addCategory() {
            const name = document.getElementById("new-category-name").value.trim();
            if (name && !categories[name]) {
                categories[name] = [];
                localStorage.setItem("categories", JSON.stringify(categories));
                currentCategory = name;
                renderCategories();
                renderMenu();
            }
        }

        function deleteCategory() {
            if (confirm(`確定刪除分類 ${currentCategory}？`)) {
                delete categories[currentCategory];
                const keys = Object.keys(categories);
                currentCategory = keys.length ? keys[0] : "";
                localStorage.setItem("categories", JSON.stringify(categories));
                localStorage.setItem("currentCategory", currentCategory);
                renderCategories();
                renderMenu();
            }
        }

        function renderMenu() {
            const menu = document.getElementById("menu");
            menu.innerHTML = "";
            categories[currentCategory]?.forEach((item, i) => {
                const price = parseFloat(item.price) || 0;
                const div = document.createElement("div");
                div.className = "d-flex align-items-center justify-content-between p-2 mb-2 border rounded";
                div.innerHTML = `
          <span>${item.name}</span>
          <span>$${price.toFixed(2)}</span>
          <div>
            <button class="btn btn-sm btn-outline-success" onclick="addToOrder('${item.name}', ${price})">加入點餐</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteMenuItem(${i})">刪除</button>
          </div>`;
                menu.appendChild(div);
            });
        }

        function addMenuItem() {
            const name = document.getElementById("new-item-name").value.trim();
            const price = parseFloat(document.getElementById("new-item-price").value);
            if (name && !isNaN(price)) {
                categories[currentCategory].push({ name, price });
                localStorage.setItem("categories", JSON.stringify(categories));
                renderMenu();
                document.getElementById("new-item-name").value = "";
                document.getElementById("new-item-price").value = "";
            }
        }

        function deleteMenuItem(index) {
            if (confirm("確定要刪除這個品項嗎？")) {
                categories[currentCategory].splice(index, 1);
                localStorage.setItem("categories", JSON.stringify(categories));
                renderMenu();
            }
        }

        function addToOrder(name, price) {
            const found = orders.find(o => o.name === name);
            if (found) found.quantity++;
            else orders.push({ name, price, quantity: 1 });
            updateOrderList();
        }

        function updateOrderList() {
            const list = document.getElementById("order-list");
            list.innerHTML = "";
            let total = 0;
            orders.forEach((item, i) => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                const row = document.createElement("div");
                row.className = "d-flex justify-content-between border-bottom p-2";
                row.innerHTML = `
          <span>${item.name} x${item.quantity}</span>
          <span>$${subtotal.toFixed(2)}</span>
          <button class="btn btn-sm btn-outline-danger" onclick="changeQty(${i}, -1)">-</button>
          <button class="btn btn-sm btn-outline-success" onclick="changeQty(${i}, 1)">+</button>
          <button class="btn btn-sm btn-outline-dark" onclick="removeItem(${i})">刪除</button>`;
                list.appendChild(row);
            });
            document.getElementById("total-price").innerText = `總價: $${total.toFixed(2)}`;
        }

        function changeQty(index, change) {
            orders[index].quantity += change;
            if (orders[index].quantity <= 0) orders.splice(index, 1);
            updateOrderList();
        }

        function removeItem(index) {
            orders.splice(index, 1);
            updateOrderList();
        }

        function completeOrder() {
            if (orders.length === 0) return alert("請先點餐");
            const all = JSON.parse(localStorage.getItem("finishedOrders")) || [];
            all.push({ time: new Date().toISOString(), items: orders });
            localStorage.setItem("finishedOrders", JSON.stringify(all));
            orders = [];
            updateOrderList();
            alert("訂單已完成");
        }

        function applyDateFilter() {
            const date = document.getElementById("filter-date").value;
            if (!date) return;
            const all = JSON.parse(localStorage.getItem("finishedOrders")) || [];
            const filtered = all.filter(o => o.time.startsWith(date));
            renderOrders(filtered);
        }

        function clearFilter() {
            document.getElementById("filter-date").value = "";
            renderOrders();
        }

        function exportToExcel() {
            const rows = [["時間", "品項名稱", "數量", "單價", "總價"]];
            const all = JSON.parse(localStorage.getItem("finishedOrders")) || [];
            all.forEach(order => {
                order.items.forEach(item => {
                    rows.push([order.time, item.name, item.quantity, item.price, item.price * item.quantity]);
                });
            });
            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "訂單紀錄");
            XLSX.writeFile(wb, "訂單紀錄.xlsx");
        }

        function renderOrders(data = null) {
            const ordersData = data || JSON.parse(localStorage.getItem("finishedOrders")) || [];
            const accordion = document.getElementById("ordersAccordion");
            accordion.innerHTML = "";
            ordersData.forEach((order, i) => {
                const total = order.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const detail = order.items.map(item => `<li>${item.name} x${item.quantity} - $${(item.price * item.quantity).toFixed(2)}</li>`).join("");
                accordion.innerHTML += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="h${i}">
              <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c${i}">${order.time} - 總金額：$${total.toFixed(2)}</button>
            </h2>
            <div id="c${i}" class="accordion-collapse collapse"><div class="accordion-body"><ul>${detail}</ul></div></div>
          </div>`;
            });
        }

        function renderChart() {
            const all = JSON.parse(localStorage.getItem("finishedOrders")) || [];
            const stats = {}, cats = JSON.parse(localStorage.getItem("categories")) || {}, labels = [], values = [];
            let total = 0;
            all.forEach(order => {
                order.items.forEach(item => {
                    total += item.price * item.quantity;
                    for (const cat in cats) {
                        if (cats[cat].some(x => typeof x === 'object' && x.name === item.name)) {
                            stats[cat] = (stats[cat] || 0) + item.price * item.quantity;
                        }
                    }
                });
            });
            for (const k in stats) {
                labels.push(k);
                values.push(stats[k]);
            }
            labels.push("當日總金額");
            values.push(total);

            const ctx = document.getElementById("categoryChart").getContext("2d");
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: '分類銷售金額', data: values }] },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        // 初始化畫面
        renderCategories();
        setCategory(currentCategory);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>